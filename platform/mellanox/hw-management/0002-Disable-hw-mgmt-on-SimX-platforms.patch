From d09e7c6e299f8e473e34f1bb80d68eda4f465d49 Mon Sep 17 00:00:00 2001
From: Volodymyr Samotiy <volodymyrs@nvidia.com>
Date: Tue, 22 Aug 2023 11:12:02 +0300
Subject: [PATCH] [PATCH 2/4] Disable hw-mgmt on SimX platforms

Signed-off-by: Volodymyr Samotiy <volodymyrs@nvidia.com>
---
 usr/usr/bin/hw-management-ready.sh | 11 +++++++----
 usr/usr/bin/hw-management.sh       |  9 +++++++++
 2 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/usr/usr/bin/hw-management-ready.sh b/usr/usr/bin/hw-management-ready.sh
index 2b736d27..931cf785 100755
--- a/usr/usr/bin/hw-management-ready.sh
+++ b/usr/usr/bin/hw-management-ready.sh
@@ -51,13 +51,14 @@ if [ -d /var/run/hw-management ]; then
 	rm -fr /var/run/hw-management
 fi
 
-case $board_type in
-VMOD0014)
+if [ -z "$(lspci -vvv | grep SimX)" ]; then
+    case $board_type in
+    VMOD0014)
 	if [ ! -d /sys/devices/pci0000:00/0000:00:1f.0/NVSN2201:00/mlxreg-hotplug/hwmon ]; then
 		timeout 180 bash -c 'until [ -d /sys/devices/pci0000:00/0000:00:1f.0/NVSN2201:00/mlxreg-hotplug/hwmon ]; do sleep 0.2; done'
 	fi
 	;;
-*)
+    *)
 	arch=$(uname -m)
 	if [ "$arch" = "aarch64" ]; then
 		plat_path=/sys/devices/platform/MLNXBF49:00
@@ -69,6 +70,8 @@ VMOD0014)
 		timeout 180 bash -c 'until [ -d ${plat_path}/mlxreg-hotplug/hwmon ]; do sleep 0.2; done'
 	fi
 	;;
-esac
+    esac
+fi
+
 echo "Start Chassis HW management service."
 logger -t hw-management -p daemon.notice "Start Chassis HW management service."
diff --git a/usr/usr/bin/hw-management.sh b/usr/usr/bin/hw-management.sh
index 0381bdfe..fd51a134 100755
--- a/usr/usr/bin/hw-management.sh
+++ b/usr/usr/bin/hw-management.sh
@@ -2323,6 +2323,13 @@ do_chip_down()
 	/usr/bin/hw-management-thermal-events.sh change hotplug_asic down %S %p
 }
 
+check_simx()
+{
+	if [ -n "$(lspci -vvv | grep SimX)" ]; then
+		exit 0
+	fi
+}
+
 __usage="
 Usage: $(basename "$0") [Options]
 
@@ -2349,6 +2356,8 @@ Options:
 	reset-cause	Output system reset cause.
 "
 
+check_simx
+
 case $ACTION in
 	start)
 		if [ -d /var/run/hw-management ]; then
-- 
2.17.1

